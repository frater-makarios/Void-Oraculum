<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oráculo Tecnomante: Clima e Caos</title>
    <style>
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        #modal-content {
            background: #0a0a0a; border: 1px solid #00d4ff; padding: 30px;
            max-width: 500px; text-align: center; box-shadow: 0 0 50px #00d4ff22;
        }
        #modal-content h3 { color: #ff00ff; margin-top: 0; letter-spacing: 3px; }
        #intento-input {
            width: 90%; padding: 10px; background: #111; border: 1px solid #ff00ff;
            color: #00d4ff; font-family: monospace; margin: 20px 0; text-align: center;
        }
        .close-modal-btn {
            background: transparent; color: #00d4ff; border: 1px solid #00d4ff;
            padding: 10px 20px; cursor: pointer; font-weight: bold; text-transform: uppercase;
        }
        body { 
            background: #050505; color: #00d4ff; font-family: 'Courier New', monospace; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            min-height: 100vh; margin: 0; 
        }
        #canvas { border: 2px solid #00d4ff; box-shadow: 0 0 30px #00d4ff55; background: #000; max-width: 90vw; }
        #status { text-align: center; min-height: 1.5em; margin-bottom: 20px; text-shadow: 0 0 8px #00d4ff; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        button { background: transparent; color: #00d4ff; border: 1px solid #00d4ff; padding: 12px 24px; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        button:hover { background: #00d4ff; color: #000; }
        .save-btn { border-color: #ff00ff; color: #ff00ff; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div id="modal-content">
            <h3>FOCALIZAR INTENTO</h3>
            <p>Escreva sua vontade abaixo. Suas palavras serão convertidas em frequência e integradas à geometria do caos.</p>
            <input type="text" id="intento-input" placeholder="Ex: Eu possuo clareza mental" autocomplete="off">
            <br>
            <button class="close-modal-btn" onclick="fecharModal()">Consagrar e Iniciar</button>
            <p style="font-size: 0.7rem; opacity: 0.5; margin-top: 15px;"><i>Projeto: Frater Markarios</i></p>
        </div>
    </div>

    <h2 id="status">INICIALIZANDO ÉTER...</h2>
    <canvas id="canvas" width="400" height="400"></canvas>
    <div id="weather-report" style="font-size: 0.8rem; margin-top: 10px; opacity: 0.6;"></div>
    
    <div class="controls">
        <button onclick="iniciarCanalizacao()">Recanalizar</button>
        <button class="save-btn" onclick="saveSigil()">Consagrar Imagem</button>
    </div>

    <script>
        const API_KEY = '205dfbe3470e81f71e2b9f2f6a46443d'; 
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        let intentoGlobal = "";

        const mensagensProcessando = ["COLHENDO ENTROPIA...", "TRANSMUTANDO INTENTO...", "MAPEANDO VOTOS...", "FRAGMENTANDO O CAOS..."];
        let loopStatus;

        function fecharModal() {
            intentoGlobal = document.getElementById('intento-input').value || "CAOS";
            document.getElementById('modal-overlay').style.display = 'none';
            iniciarCanalizacao();
        }

        function rotacionarMensagens(lista) {
            let i = 0;
            clearInterval(loopStatus);
            loopStatus = setInterval(() => {
                statusEl.innerText = lista[i];
                i = (i + 1) % lista.length;
            }, 2500);
        }

        function iniciarCanalizacao() {
            rotacionarMensagens(mensagensProcessando);
            navigator.geolocation.getCurrentPosition(pos => {
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&appid=${API_KEY}&units=metric`)
                .then(r => r.json()).then(data => { clearInterval(loopStatus); drawSigil(data); });
            }, err => { clearInterval(loopStatus); statusEl.innerText = "ERRO GEOGRÁFICO"; });
        }

        function drawSigil(data) {
            const temp = data.main.temp;         
            const wind = data.wind.speed || 1;    
            const humidity = data.main.humidity; 
            const agora = new Date();
            
            // CONVERSÃO DO INTENTO EM NÚMERO (Semente Mística)
            let intentoValue = 0;
            for(let i=0; i < intentoGlobal.length; i++) {
                intentoValue += intentoGlobal.charCodeAt(i);
            }

            statusEl.innerText = `SIGILO FIRMADO: ${intentoGlobal.toUpperCase()}`;
            document.getElementById('weather-report').innerText = `T: ${temp}°C | INTENTO_VAL: ${intentoValue}`;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const hue = (200 - (temp * 3)) + (agora.getSeconds() * 2);
            ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.shadowBlur = 10; ctx.shadowColor = ctx.strokeStyle;
            
            let steps = Math.max(8, Math.floor((humidity / 3) + (intentoGlobal.length))); 
            let points = [];

            for (let i = 0; i < steps; i++) {
                let angle = (i / steps) * Math.PI * 2;
                // O Intento agora influencia o raio e a vibração
                let radius = 110 + Math.sin(i * wind + intentoValue) * 60;
                points.push({ x: 200 + Math.cos(angle) * radius, y: 200 + Math.sin(angle) * radius });
            }

            ctx.beginPath();
            ctx.setLineDash([2, 5]);
            ctx.arc(200, 200, 165, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.beginPath();
            ctx.lineWidth = 1.5;
            for (let i = 0; i < points.length; i++) {
                let next = (i + 1) % steps;
                // O "pulo" das conexões depende do peso das palavras do intento
                let jump = (intentoValue % 3 === 0) ? 2 : 3;
                let far = (i + jump) % steps;
                
                ctx.moveTo(points[i].x, points[i].y);
                ctx.lineTo(points[next].x, points[next].y);
                ctx.moveTo(points[i].x, points[i].y);
                ctx.lineTo(points[far].x, points[far].y);
                ctx.fillRect(points[i].x - 2, points[i].y - 2, 4, 4);
            }
            ctx.stroke();

            ctx.shadowBlur = 0; ctx.font = "8px monospace"; ctx.fillStyle = "#ffffff33";
            ctx.fillText(`FRATER MARKARIOS // INTENTO: ${intentoGlobal}`, 10, 390);
        }

        function saveSigil() {
            const link = document.createElement('a');
            link.download = `sigilo-${intentoGlobal.replace(/\s+/g, '-')}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
