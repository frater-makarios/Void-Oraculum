<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oráculo Tecnomante: Clima e Caos</title>
    <style>
        body { 
            background: #050505; 
            color: #00d4ff; 
            font-family: 'Courier New', monospace; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
        }
        #canvas { 
            border: 2px solid #00d4ff; 
            box-shadow: 0 0 30px #00d4ff55; 
            background: #000; 
            max-width: 90vw;
        }
        .info { margin-top: 15px; text-align: center; font-size: 0.9rem; color: #00d4ff; opacity: 0.7; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        button { 
            background: transparent; 
            color: #00d4ff; 
            border: 1px solid #00d4ff; 
            padding: 12px 24px; 
            cursor: pointer; 
            margin-top: 20px; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            transition: 0.3s;
        }
        button:hover { background: #00d4ff; color: #000; box-shadow: 0 0 15px #00d4ff; }
        .save-btn { border-color: #ff00ff; color: #ff00ff; }
        .save-btn:hover { background: #ff00ff; color: #000; box-shadow: 0 0 15px #ff00ff; }
    </style>
</head>
<body>

    <h2 id="status">SINCROZINANDO COM O ÉTER...</h2>
    <canvas id="canvas" width="400" height="400"></canvas>
    
    <div id="weather-report" class="info">Aguardando comando para canalização...</div>
    
    <div class="controls">
        <button onclick="fetchWeatherAndDraw()">Canalizar Clima Local</button>
        <button class="save-btn" onclick="saveSigil()">Consagrar Imagem (PNG)</button>
    </div>

    <script>
        const API_KEY = '205dfbe3470e81f71e2b9f2f6a46443d'; 
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function fetchWeatherAndDraw() {
            document.getElementById('status').innerText = "CAPTURANDO GEOLOCALIZAÇÃO...";

            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`)
                    .then(response => {
                        if (!response.ok) throw new Error('Falha na autenticação da API');
                        return response.json();
                    })
                    .then(data => {
                        drawSigil(data);
                    })
                    .catch(err => {
                        document.getElementById('status').innerText = "ERRO NA CONEXÃO MÍSTICA";
                        console.error(err);
                    });
            }, error => {
                document.getElementById('status').innerText = "LOCALIZAÇÃO NEGADA";
                alert("A geolocalização é necessária para o ritual.");
            });
        }

        function drawSigil(data) {
            const temp = data.main.temp;         
            const wind = data.wind.speed || 1;    
            const humidity = data.main.humidity; 
            const city = data.name;
            const entropy = Date.now();

            document.getElementById('status').innerText = `SIGILO DE ${city.toUpperCase()}`;
            document.getElementById('weather-report').innerText = `Temp: ${temp}°C | Vento: ${wind}m/s | Humidade: ${humidity}%`;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const hue = 200 - (temp * 3);
            ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.shadowBlur = 10;
            ctx.shadowColor = `hsl(${hue}, 100%, 50%)`;
            
            let centerX = 200;
            let centerY = 200;
            let points = [];
            // O número de pontas depende da humidade
            let steps = Math.max(6, Math.floor(humidity / 4)); 

            // 1. Calcular pontos de ancoragem
            for (let i = 0; i < steps; i++) {
                let angle = (i / steps) * Math.PI * 2;
                // O vento causa distorção nos raios
                let radius = 130 + Math.sin(i * wind + entropy) * 40;
                points.push({
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius
                });
            }

            // 2. Desenhar Circunferências de Contenção (Geometria Alquímica)
            ctx.beginPath();
            ctx.lineWidth = 1;
            ctx.arc(centerX, centerY, 160, 0, Math.PI * 2);
            ctx.setLineDash([5, 10]); // Efeito rúnico tracejado
            ctx.stroke();
            ctx.setLineDash([]); // Reset

            ctx.beginPath();
            ctx.arc(centerX, centerY, 150, 0, Math.PI * 2);
            ctx.stroke();

            // 3. Traçar Conexões (Lógica de Sigilo)
            ctx.beginPath();
            ctx.lineWidth = 1.5 + (wind / 4);
            for (let i = 0; i < points.length; i++) {
                // Conecta cada ponto ao próximo e a um ponto oposto (salto de entropia)
                let next = (i + 1) % steps;
                let far = (i + Math.floor(steps / 2)) % steps;
                
                ctx.moveTo(points[i].x, points[i].y);
                ctx.lineTo(points[next].x, points[next].y);
                
                ctx.moveTo(points[i].x, points[i].y);
                ctx.lineTo(points[far].x, points[far].y);

                // Desenha pequenos nodos (círculos) em cada vértice
                ctx.fillRect(points[i].x - 2, points[i].y - 2, 4, 4);
            }
            ctx.stroke();

            // 4. Inserir Glifos Digitais
            ctx.shadowBlur = 0;
            ctx.font = "9px monospace";
            ctx.fillStyle = "#ffffff44";
            points.forEach((p, i) => {
                if (i % 2 === 0) {
                    ctx.fillText("0x" + (entropy + i).toString(16).slice(-4), p.x + 8, p.y);
                }
            });

            // Núcleo do Sigilo
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillText(`STREAM_ID: ${entropy}`, 10, 390);
        }

        function saveSigil() {
            const link = document.createElement('a');
            link.download = `sigilo-tecnomante-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
