<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oráculo Tecnomante: Clima e Caos</title>
    <style>
        /* ESTILOS DO MODAL */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #modal-content {
            background: #0a0a0a;
            border: 1px solid #00d4ff;
            padding: 30px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 50px #00d4ff22;
        }
        #modal-content h3 { color: #ff00ff; margin-top: 0; }
        #modal-content p { line-height: 1.6; font-size: 0.9rem; color: #00d4ff; }
        .close-modal-btn {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* ESTILOS GERAIS */
        body { 
            background: #050505; 
            color: #00d4ff; 
            font-family: 'Courier New', monospace; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
        }
        #canvas { 
            border: 2px solid #00d4ff; 
            box-shadow: 0 0 30px #00d4ff55; 
            background: #000; 
            max-width: 90vw;
        }
        .info { margin-top: 15px; text-align: center; font-size: 0.9rem; color: #00d4ff; opacity: 0.7; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        button { 
            background: transparent; 
            color: #00d4ff; 
            border: 1px solid #00d4ff; 
            padding: 12px 24px; 
            cursor: pointer; 
            margin-top: 20px; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            transition: 0.3s;
        }
        button:hover { background: #00d4ff; color: #000; box-shadow: 0 0 15px #00d4ff; }
        .save-btn { border-color: #ff00ff; color: #ff00ff; }
        .save-btn:hover { background: #ff00ff; color: #000; box-shadow: 0 0 15px #ff00ff; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div id="modal-content">
            <h3>DIAGNÓSTICO TECNOMÂNTICO</h3>
            <p>
                Este sistema transmuta dados atmosféricos em geometria sigilar. 
                Utilizamos <strong>temperatura, vento e umidade</strong> colhidos em tempo real via API para moldar o caos logico.
            </p>
            <p><i>Projeto desenvolvido por <strong>Frater Markarios</strong>.</i></p>
            <button class="close-modal-btn" onclick="fecharModal()">Iniciar Ritual</button>
        </div>
    </div>

    <h2 id="status">SINCROZINANDO COM O ÉTER...</h2>
    <canvas id="canvas" width="400" height="400"></canvas>
    
    <div id="weather-report" class="info">Aguardando comando para canalização...</div>
    
    <div class="controls">
        <button onclick="fetchWeatherAndDraw()">Canalizar Clima Local</button>
        <button class="save-btn" onclick="saveSigil()">Consagrar Imagem (PNG)</button>
    </div>

    <script>
        const API_KEY = '205dfbe3470e81f71e2b9f2f6a46443d'; 
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Função para fechar o modal
        function fecharModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function fetchWeatherAndDraw() {
            document.getElementById('status').innerText = "CAPTURANDO GEOLOCALIZAÇÃO...";

            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`)
                    .then(response => {
                        if (!response.ok) throw new Error('API Key inválida');
                        return response.json();
                    })
                    .then(data => drawSigil(data))
                    .catch(err => {
                        document.getElementById('status').innerText = "ERRO NA CONEXÃO";
                        console.error(err);
                    });
            }, error => {
                document.getElementById('status').innerText = "LOCALIZAÇÃO NEGADA";
                alert("A geolocalização é necessária para o ritual.");
            });
        }

        function drawSigil(data) {
            const temp = data.main.temp;         
            const wind = data.wind.speed || 1;    
            const humidity = data.main.humidity; 
            const city = data.name;
            const entropy = Date.now();

            document.getElementById('status').innerText = `SIGILO DE ${city.toUpperCase()}`;
            document.getElementById('weather-report').innerText = `Temp: ${temp}°C | Vento: ${wind}m/s | Humidade: ${humidity}%`;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const hue = 200 - (temp * 3);
            ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.shadowBlur = 10;
            ctx.shadowColor = `hsl(${hue}, 100%, 50%)`;
            
            let centerX = 200;
            let centerY = 200;
            let points = [];
            let steps = Math.max(6, Math.floor(humidity / 4)); 

            for (let i = 0; i < steps; i++) {
                let angle = (i / steps) * Math.PI * 2;
                let radius = 130 + Math.sin(i * wind + entropy) * 40;
                points.push({
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius
                });
            }

            // Geometria Alquímica
            ctx.beginPath();
            ctx.lineWidth = 1;
            ctx.arc(centerX, centerY, 150, 0, Math.PI * 2);
            ctx.setLineDash([5, 10]);
            ctx.stroke();
            ctx.setLineDash([]); 

            // Conexões de Sigilo
            ctx.beginPath();
            ctx.lineWidth = 1.5;
            for (let i = 0; i < points.length; i++) {
                let next = (i + 1) % steps;
                let far = (i + Math.floor(steps / 2)) % steps;
                
                ctx.moveTo(points[i].x, points[i].y);
                ctx.lineTo(points[next].x, points[next].y);
                ctx.moveTo(points[i].x, points[i].y);
                ctx.lineTo(points[far].x, points[far].y);
                ctx.fillRect(points[i].x - 2, points[i].y - 2, 4, 4);
            }
            ctx.stroke();

            // Glifos
            ctx.shadowBlur = 0;
            ctx.font = "9px monospace";
            ctx.fillStyle = "#ffffff44";
            points.forEach((p, i) => {
                if (i % 2 === 0) ctx.fillText("0x" + (entropy + i).toString(16).slice(-4), p.x + 8, p.y);
            });

            ctx.fillText(`AUTOR: FRATER MARKARIOS`, 10, 15);
            ctx.fillText(`ENTROPIA: ${entropy}`, 10, 390);
        }

        function saveSigil() {
            const link = document.createElement('a');
            link.download = `sigilo-markarios-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
