<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oráculo Tecnomante: Clima e Caos</title>
    <style>
        body { 
            background: #050505; 
            color: #00d4ff; 
            font-family: 'Courier New', monospace; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
        }
        #canvas { 
            border: 2px solid #00d4ff; 
            box-shadow: 0 0 30px #00d4ff55; 
            background: #000; 
            max-width: 90vw;
        }
        .info { margin-top: 15px; text-align: center; font-size: 0.9rem; color: #00d4ff; opacity: 0.7; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        button { 
            background: transparent; 
            color: #00d4ff; 
            border: 1px solid #00d4ff; 
            padding: 12px 24px; 
            cursor: pointer; 
            margin-top: 20px; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            transition: 0.3s;
        }
        button:hover { background: #00d4ff; color: #000; box-shadow: 0 0 15px #00d4ff; }
        .save-btn { border-color: #ff00ff; color: #ff00ff; }
        .save-btn:hover { background: #ff00ff; color: #000; box-shadow: 0 0 15px #ff00ff; }
    </style>
</head>
<body>

    <h2 id="status">SINCROZINANDO COM O ÉTER...</h2>
    <canvas id="canvas" width="400" height="400"></canvas>
    
    <div id="weather-report" class="info">Clique para iniciar a canalização atmosférica...</div>
    
    <div class="controls">
        <button onclick="fetchWeatherAndDraw()">Canalizar Clima Local</button>
        <button class="save-btn" onclick="saveSigil()">Consagrar Imagem (PNG)</button>
    </div>

    <script>
        const API_KEY = '205dfbe3470e81f71e2b9f2f6a46443d'; 
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function fetchWeatherAndDraw() {
            document.getElementById('status').innerText = "CAPTURANDO GEOLOCALIZAÇÃO...";

            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`)
                    .then(response => {
                        if (!response.ok) throw new Error('API Key ainda não ativa ou inválida');
                        return response.json();
                    })
                    .then(data => {
                        drawSigil(data);
                    })
                    .catch(err => {
                        document.getElementById('status').innerText = "ERRO NA CONEXÃO MÍSTICA";
                        console.error(err);
                        alert("Erro: " + err.message + "\nNota: Chaves novas da OpenWeather podem demorar até 2 horas para ativar.");
                    });
            }, error => {
                document.getElementById('status').innerText = "LOCALIZAÇÃO NEGADA";
                alert("A tecnomancia exige saber onde você está no globo.");
            });
        }

        function drawSigil(data) {
            const temp = data.main.temp;         
            const wind = data.wind.speed || 1;    
            const humidity = data.main.humidity; 
            const city = data.name;
            const entropy = Date.now();

            document.getElementById('status').innerText = `ORÁCULO DE ${city.toUpperCase()}`;
            document.getElementById('weather-report').innerText = `Temp: ${temp}°C | Vento: ${wind}m/s | Umidade: ${humidity}%`;

            // Limpar Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Estética baseada no clima: Quente = Vermelho/Laranja | Frio = Azul/Ciano
            const hue = 200 - (temp * 3); // Ajuste de cor dinâmico
            ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.shadowBlur = 15;
            ctx.shadowColor = `hsl(${hue}, 100%, 50%)`;
            ctx.lineWidth = 2 + (wind / 3);
            
            ctx.beginPath();
            // A umidade dita quantos "vértices" a forma tem
            let steps = Math.max(3, Math.floor(humidity / 4)); 
            let centerX = 200;
            let centerY = 200;

            for (let i = 0; i <= steps; i++) {
                let angle = (i / steps) * Math.PI * 2;
                // O vento distorce o raio da geometria
                let variation = Math.sin(angle * wind + entropy) * 40;
                let radius = 120 + variation; 
                
                let x = centerX + Math.cos(angle) * radius;
                let y = centerY + Math.sin(angle) * radius;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }

            ctx.closePath();
            ctx.stroke();

            // Glifos informativos (A assinatura do tempo)
            ctx.shadowBlur = 0;
            ctx.fillStyle = "#ffffff22";
            ctx.font = "10px monospace";
            ctx.fillText(`HASH_TEMPO: ${entropy.toString(16)}`, 10, 20);
            ctx.fillText(`COORD: ${city}`, 10, 380);
            ctx.fillText(`TERM: ${temp}C / HUMID: ${humidity}%`, 10, 395);
        }

        function saveSigil() {
            const link = document.createElement('a');
            link.download = `sigilo-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
